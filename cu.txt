import 'package:flutter/material.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:http/http.dart' as http;
import 'dart:async';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Kh·ªüi t·∫°o notifications
  await initNotifications();
  
  // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
  await Permission.notification.request();
  
  runApp(MyApp());
}

// Notification setup
final FlutterLocalNotificationsPlugin notifications = FlutterLocalNotificationsPlugin();

Future<void> initNotifications() async {
  const AndroidInitializationSettings androidSettings = 
      AndroidInitializationSettings('@mipmap/ic_launcher');
  
  const DarwinInitializationSettings iosSettings =
      DarwinInitializationSettings(
    requestAlertPermission: true,
    requestBadgePermission: true,
    requestSoundPermission: true,
  );
  
  const InitializationSettings initSettings = InitializationSettings(
    android: androidSettings,
    iOS: iosSettings,
  );
  
  await notifications.initialize(initSettings);
}

Future<void> showNotification(String title, String body) async {
  const AndroidNotificationDetails androidPlatformChannelSpecifics =
      AndroidNotificationDetails(
    'network_channel',
    'Network Monitoring',
    channelDescription: 'Notifications for network activity',
    importance: Importance.high,
    priority: Priority.high,
  );
  
  const DarwinNotificationDetails iosPlatformChannelSpecifics =
      DarwinNotificationDetails(
    presentAlert: true,
    presentBadge: true,
    presentSound: true,
  );
  
  const NotificationDetails platformChannelSpecifics = NotificationDetails(
    android: androidPlatformChannelSpecifics,
    iOS: iosPlatformChannelSpecifics,
  );
  
  await notifications.show(
    0,
    title,
    body,
    platformChannelSpecifics,
  );
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'iOS Network Monitor',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        useMaterial3: true,
      ),
      home: NetworkMonitorScreen(),
    );
  }
}

class NetworkMonitorScreen extends StatefulWidget {
  @override
  _NetworkMonitorScreenState createState() => _NetworkMonitorScreenState();
}

class _NetworkMonitorScreenState extends State<NetworkMonitorScreen> {
  final Connectivity _connectivity = Connectivity();
  final List<NetworkEvent> _networkEvents = [];
  
  String _connectionStatus = 'ƒêang ki·ªÉm tra...';
  String _networkActivity = 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông';
  int _dataCounter = 0;
  bool _isMonitoring = false;
  Timer? _monitoringTimer;
  DateTime? _lastActivityTime;
  
  // URLs ƒë·ªÉ test network activity
  final List<String> _testUrls = [
    'https://www.google.com',
    'https://www.apple.com',
    'https://jsonplaceholder.typicode.com/posts/1',
  ];

  @override
  void initState() {
    super.initState();
    _initNetworkListener();
  }

  void _initNetworkListener() async {
    // Ki·ªÉm tra tr·∫°ng th√°i ban ƒë·∫ßu - ƒê√É S·ª¨A L·ªñI
    var initialResult = await _connectivity.checkConnectivity();
    _updateConnectionStatus(initialResult); // ƒê√É S·ª¨A: b·ªè d·∫•u ngo·∫∑c vu√¥ng
    
    // L·∫Øng nghe thay ƒë·ªïi k·∫øt n·ªëi - ƒê√É S·ª¨A L·ªñI
    _connectivity.onConnectivityChanged.listen((ConnectivityResult result) {
      _updateConnectionStatus(result);
    });
  }

  // ƒê√É S·ª¨A L·ªñI: H√†m n√†y nh·∫≠n ConnectivityResult thay v√¨ List<ConnectivityResult>
  void _updateConnectionStatus(ConnectivityResult result) {
    String status = '';
    Color statusColor = Colors.red;
    
    // ƒê√É S·ª¨A: D√πng == thay v√¨ .contains()
    if (result == ConnectivityResult.wifi) {
      status = 'üì∂ ƒêang k·∫øt n·ªëi WiFi';
      statusColor = Colors.green;
    } else if (result == ConnectivityResult.mobile) {
      status = 'üì± ƒêang k·∫øt n·ªëi Mobile Data';
      statusColor = Colors.orange;
    } else if (result == ConnectivityResult.ethernet) {
      status = 'üîå ƒêang k·∫øt n·ªëi Ethernet';
      statusColor = Colors.blue;
    } else {
      status = '‚ùå M·∫•t k·∫øt n·ªëi Internet';
      statusColor = Colors.red;
    }
    
    setState(() {
      _connectionStatus = status;
    });
    
    // Th√™m s·ª± ki·ªán v√†o l·ªãch s·ª≠
    _addNetworkEvent('Thay ƒë·ªïi k·∫øt n·ªëi: $status');
    
    // G·ª≠i th√¥ng b√°o khi c√≥ thay ƒë·ªïi k·∫øt n·ªëi
    showNotification('Thay ƒë·ªïi k·∫øt n·ªëi', status);
  }

  void _startMonitoring() {
    setState(() {
      _isMonitoring = true;
      _dataCounter = 0;
      _networkActivity = 'B·∫Øt ƒë·∫ßu gi√°m s√°t...';
    });
    
    // Timer ƒë·ªÉ m√¥ ph·ªèng vi·ªác ph√°t hi·ªán network activity
    _monitoringTimer = Timer.periodic(Duration(seconds: 5), (timer) {
      _simulateNetworkActivity();
    });
    
    _addNetworkEvent('B·∫Øt ƒë·∫ßu gi√°m s√°t m·∫°ng');
    showNotification('Gi√°m s√°t m·∫°ng', 'ƒê√£ b·∫Øt ƒë·∫ßu theo d√µi ho·∫°t ƒë·ªông m·∫°ng');
  }

  void _stopMonitoring() {
    _monitoringTimer?.cancel();
    setState(() {
      _isMonitoring = false;
      _networkActivity = 'ƒê√£ d·ª´ng gi√°m s√°t';
    });
    
    _addNetworkEvent('D·ª´ng gi√°m s√°t m·∫°ng');
    showNotification('Gi√°m s√°t m·∫°ng', 'ƒê√£ d·ª´ng theo d√µi ho·∫°t ƒë·ªông m·∫°ng');
  }

  Future<void> _simulateNetworkActivity() async {
    try {
      // Th·ª±c hi·ªán c√°c request test ƒë·ªÉ ph√°t hi·ªán network activity
      for (String url in _testUrls) {
        final startTime = DateTime.now();
        final response = await http.get(Uri.parse(url)).timeout(Duration(seconds: 10));
        final endTime = DateTime.now();
        final duration = endTime.difference(startTime);
        
        if (response.statusCode == 200) {
          setState(() {
            _dataCounter++;
            _lastActivityTime = DateTime.now();
            _networkActivity = 'üîÑ ƒêang l∆∞·ªõt m·∫°ng - L·∫ßn: $_dataCounter\n'
                              'Th·ªùi gian ph·∫£n h·ªìi: ${duration.inMilliseconds}ms';
          });
          
          _addNetworkEvent('Network activity detected - Response: ${response.statusCode}');
          
          // G·ª≠i th√¥ng b√°o khi ph√°t hi·ªán activity (gi·ªõi h·∫°n ƒë·ªÉ tr√°nh spam)
          if (_dataCounter % 5 == 0) {
            showNotification(
              'Ho·∫°t ƒë·ªông m·∫°ng', 
              'ƒê√£ ph√°t hi·ªán $_dataCounter l·∫ßn truy c·∫≠p m·∫°ng'
            );
          }
        }
      }
    } catch (e) {
      _addNetworkEvent('L·ªói ki·ªÉm tra m·∫°ng: $e');
    }
  }

  void _testSingleRequest() async {
    try {
      setState(() {
        _networkActivity = 'üîÑ ƒêang ki·ªÉm tra k·∫øt n·ªëi...';
      });
      
      final response = await http.get(Uri.parse('https://www.apple.com'));
      
      setState(() {
        _dataCounter++;
        _networkActivity = '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng\n'
                          'Status: ${response.statusCode}\n'
                          'Th·ªùi gian: ${DateTime.now().toString()}';
      });
      
      _addNetworkEvent('Test request th√†nh c√¥ng: ${response.statusCode}');
      showNotification('Test m·∫°ng', 'K·∫øt n·ªëi th√†nh c√¥ng - Status: ${response.statusCode}');
      
    } catch (e) {
      setState(() {
        _networkActivity = '‚ùå L·ªói k·∫øt n·ªëi: $e';
      });
      _addNetworkEvent('Test request th·∫•t b·∫°i: $e');
    }
  }

  void _addNetworkEvent(String description) {
    final event = NetworkEvent(
      description: description,
      timestamp: DateTime.now(),
    );
    
    setState(() {
      _networkEvents.insert(0, event);
      // Gi·ªõi h·∫°n l·ªãch s·ª≠ 50 s·ª± ki·ªán
      if (_networkEvents.length > 50) {
        _networkEvents.removeLast();
      }
    });
  }

  void _clearHistory() {
    setState(() {
      _networkEvents.clear();
    });
  }

  // H√†m n√†y ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i k·∫øt n·ªëi trong UI
  String _getConnectionStatusText() {
    // So s√°nh v·ªõi text trong bi·∫øn _connectionStatus
    if (_connectionStatus.contains('Mobile')) {
      return 'K·∫øt n·ªëi Mobile Data';
    } else if (_connectionStatus.contains('WiFi')) {
      return 'K·∫øt n·ªëi WiFi';
    } else if (_connectionStatus.contains('Ethernet')) {
      return 'K·∫øt n·ªëi Ethernet';
    } else {
      return 'Kh√¥ng c√≥ k·∫øt n·ªëi';
    }
  }

  @override
  void dispose() {
    _monitoringTimer?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('iOS Network Monitor'),
        backgroundColor: Colors.blue,
        actions: [
          IconButton(
            icon: Icon(Icons.delete),
            onPressed: _clearHistory,
            tooltip: 'X√≥a l·ªãch s·ª≠',
          ),
        ],
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Tr·∫°ng th√°i k·∫øt n·ªëi
            _buildStatusCard(),
            
            SizedBox(height: 20),
            
            // Ho·∫°t ƒë·ªông m·∫°ng
            _buildActivityCard(),
            
            SizedBox(height: 20),
            
            // N√∫t ƒëi·ªÅu khi·ªÉn
            _buildControlButtons(),
            
            SizedBox(height: 20),
            
            // L·ªãch s·ª≠ ho·∫°t ƒë·ªông
            Expanded(
              child: _buildEventHistory(),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildStatusCard() {
    return Card(
      elevation: 4,
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            Icon(
              Icons.network_check,
              size: 48,
              color: _connectionStatus.contains('M·∫•t k·∫øt n·ªëi') ? Colors.red : Colors.green,
            ),
            SizedBox(height: 10),
            Text(
              'Tr·∫°ng th√°i k·∫øt n·ªëi',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 5),
            Text(
              _connectionStatus,
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: _connectionStatus.contains('M·∫•t k·∫øt n·ªëi') ? Colors.red : Colors.green,
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 10),
            Text(
              'S·ªë l·∫ßn truy c·∫≠p: $_dataCounter',
              style: TextStyle(fontSize: 14, color: Colors.grey),
            ),
            if (_lastActivityTime != null)
              Text(
                'L·∫ßn cu·ªëi: ${_lastActivityTime!.toString().substring(11, 19)}',
                style: TextStyle(fontSize: 12, color: Colors.grey),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildActivityCard() {
    return Card(
      elevation: 4,
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Ho·∫°t ƒë·ªông m·∫°ng',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 10),
            Text(
              _networkActivity,
              style: TextStyle(
                fontSize: 14,
                color: _networkActivity.contains('L·ªói') ? Colors.red : Colors.black87,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildControlButtons() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
      children: [
        ElevatedButton.icon(
          onPressed: _testSingleRequest,
          icon: Icon(Icons.wifi_find),
          label: Text('Test M·∫°ng'),
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.blue,
            foregroundColor: Colors.white,
          ),
        ),
        
        ElevatedButton.icon(
          onPressed: _isMonitoring ? _stopMonitoring : _startMonitoring,
          icon: Icon(_isMonitoring ? Icons.stop : Icons.play_arrow),
          label: Text(_isMonitoring ? 'D·ª´ng' : 'B·∫Øt ƒë·∫ßu'),
          style: ElevatedButton.styleFrom(
            backgroundColor: _isMonitoring ? Colors.red : Colors.green,
            foregroundColor: Colors.white,
          ),
        ),
      ],
    );
  }

  Widget _buildEventHistory() {
    return Card(
      elevation: 4,
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            Text(
              'L·ªãch s·ª≠ ho·∫°t ƒë·ªông (${_networkEvents.length})',
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 10),
            Expanded(
              child: _networkEvents.isEmpty
                  ? Center(
                      child: Text(
                        'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o',
                        style: TextStyle(color: Colors.grey),
                      ),
                    )
                  : ListView.builder(
                      itemCount: _networkEvents.length,
                      itemBuilder: (context, index) {
                        final event = _networkEvents[index];
                        return ListTile(
                          leading: Icon(Icons.history, size: 20),
                          title: Text(
                            event.description,
                            style: TextStyle(fontSize: 12),
                          ),
                          subtitle: Text(
                            '${event.timestamp.hour}:${event.timestamp.minute}:${event.timestamp.second}',
                            style: TextStyle(fontSize: 10),
                          ),
                          dense: true,
                        );
                      },
                    ),
            ),
          ],
        ),
      ),
    );
  }
}

class NetworkEvent {
  final String description;
  final DateTime timestamp;

  NetworkEvent({
    required this.description,
    required this.timestamp,
  });
}